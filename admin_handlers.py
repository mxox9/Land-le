import telebot
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton
import os
from database import (
    users_collection, orders_collection, deposits_collection,
    update_user_balance, get_user, log_admin_action,
    set_bot_accepting_orders, is_bot_accepting_orders,
    get_total_users, get_total_orders, get_total_deposits
)
import services
from utils import style_text, is_admin
from keyboards import (
    admin_main_keyboard, admin_services_keyboard, admin_balance_keyboard,
    admin_user_keyboard, admin_bot_control_keyboard, services_list_keyboard,
    confirm_delete_keyboard, broadcast_confirmation_keyboard
)

# Admin states for conversation flow
admin_states = {}

def setup_admin_handlers(bot):
    """Setup all admin handlers"""
    
    @bot.message_handler(commands=['admin'])
    def admin_panel(message):
        user_id = message.chat.id
        admin_ids = [int(x) for x in os.getenv('ADMIN_IDS', '6052975324').split(',')]
        
        if not is_admin(user_id, admin_ids):
            bot.reply_to(message, style_text("‚ùå Y·¥è·¥ú ·¥Ä Ä·¥á …¥·¥è·¥õ ·¥Ä·¥ú·¥õ ú·¥è Ä…™·¥¢·¥á·¥Ö ·¥õ·¥è ·¥ús·¥á ·¥õ ú…™s ·¥Ñ·¥è·¥ç·¥ç·¥Ä…¥·¥Ö."))
            return
        
        total_users = get_total_users()
        total_orders = get_total_orders()
        total_deposit = get_total_deposits()
        bot_status = "üü¢ ON" if is_bot_accepting_orders() else "üî¥ OFF"
        
        text = style_text(f"""
üëë A·¥Ö·¥ç…™…¥ P·¥Ä…¥·¥á ü

üë§ Us·¥á Äs: {total_users}
üõí O Ä·¥Ö·¥á Äs: {total_orders}
üí∞ T·¥è·¥õ·¥Ä ü D·¥á·¥ò·¥ès…™·¥õs: ‚Çπ{total_deposit:.2f}
üì± A·¥Ñ·¥õ…™·¥†·¥á S·¥á Ä·¥†…™·¥Ñ·¥ás: {len(services.get_all_services())}
‚öôÔ∏è B·¥è·¥õ S·¥õ·¥Ä·¥õ·¥ús: {bot_status}

C ú·¥è·¥ès·¥á ·¥Ä…¥ ·¥Ä·¥Ñ·¥õ…™·¥è…¥:
        """)
        
        bot.send_message(user_id, text, reply_markup=admin_main_keyboard())

    @bot.callback_query_handler(func=lambda call: call.data.startswith('admin_'))
    def handle_admin_callbacks(call):
        user_id = call.message.chat.id
        admin_ids = [int(x) for x in os.getenv('ADMIN_IDS', '6052975324').split(',')]
        
        if not is_admin(user_id, admin_ids):
            bot.answer_callback_query(call.id, style_text("‚ùå N·¥è·¥õ ·¥Ä·¥ú·¥õ ú·¥è Ä…™·¥¢·¥á·¥Ö!"), show_alert=True)
            return
        
        try:
            if call.data == "admin_menu":
                show_admin_menu(bot, call)
            
            elif call.data == "admin_manage_services":
                show_admin_services_menu(bot, call)
            
            elif call.data == "admin_balance_control":
                show_admin_balance_menu(bot, call)
            
            elif call.data == "admin_user_control":
                show_admin_user_menu(bot, call)
            
            elif call.data == "admin_broadcast":
                start_admin_broadcast(bot, call)
            
            elif call.data == "admin_bot_control":
                show_admin_bot_control(bot, call)
            
            elif call.data == "admin_stats":
                show_admin_stats(bot, call)
            
            elif call.data == "admin_add_service":
                start_add_service(bot, call)
            
            elif call.data == "admin_edit_service":
                show_services_for_edit(bot, call)
            
            elif call.data == "admin_delete_service":
                show_services_for_delete(bot, call)
            
            elif call.data.startswith("admin_edit_"):
                service_id = call.data.replace("admin_edit_", "")
                start_edit_service(bot, call, service_id)
            
            elif call.data.startswith("admin_delete_"):
                service_id = call.data.replace("admin_delete_", "")
                confirm_delete_service(bot, call, service_id)
            
            elif call.data.startswith("admin_confirm_delete_"):
                service_id = call.data.replace("admin_confirm_delete_", "")
                delete_service_handler(bot, call, service_id)
            
            elif call.data == "admin_add_balance":
                start_add_balance(bot, call)
            
            elif call.data == "admin_deduct_balance":
                start_deduct_balance(bot, call)
            
            elif call.data == "admin_ban_user":
                start_ban_user(bot, call)
            
            elif call.data == "admin_unban_user":
                start_unban_user(bot, call)
            
            elif call.data == "admin_bot_on":
                set_bot_status(bot, call, True)
            
            elif call.data == "admin_bot_off":
                set_bot_status(bot, call, False)
            
            elif call.data == "admin_bot_status":
                show_bot_status(bot, call)
            
            elif call.data == "admin_confirm_broadcast":
                confirm_broadcast(bot, call)
                
        except Exception as e:
            print(f"Admin callback error: {e}")
            bot.answer_callback_query(call.id, style_text("‚ùå A…¥ ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä Ä·¥á·¥Ö!"))

    # Admin menu functions
    def show_admin_menu(bot, call):
        admin_panel(call.message)

    def show_admin_services_menu(bot, call):
        user_id = call.message.chat.id
        text = style_text("üì± S·¥á Ä·¥†…™·¥Ñ·¥ás M·¥Ä…¥·¥Ä…¢·¥á·¥ç·¥á…¥·¥õ\n\nS·¥á ü·¥á·¥Ñ·¥õ ·¥Ä…¥ ·¥Ä·¥Ñ·¥õ…™·¥è…¥:")
        try:
            bot.edit_message_text(
                chat_id=user_id,
                message_id=call.message.message_id,
                text=text,
                reply_markup=admin_services_keyboard()
            )
        except:
            bot.send_message(user_id, text, reply_markup=admin_services_keyboard())

    def show_admin_balance_menu(bot, call):
        user_id = call.message.chat.id
        text = style_text("üí∞ B·¥Ä ü·¥Ä…¥·¥Ñ·¥á C·¥è…¥·¥õ Ä·¥è ü\n\nS·¥á ü·¥á·¥Ñ·¥õ ·¥Ä…¥ ·¥Ä·¥Ñ·¥õ…™·¥è…¥:")
        try:
            bot.edit_message_text(
                chat_id=user_id,
                message_id=call.message.message_id,
                text=text,
                reply_markup=admin_balance_keyboard()
            )
        except:
            bot.send_message(user_id, text, reply_markup=admin_balance_keyboard())

    def show_admin_user_menu(bot, call):
        user_id = call.message.chat.id
        text = style_text("üë§ Us·¥á Ä C·¥è…¥·¥õ Ä·¥è ü\n\nS·¥á ü·¥á·¥Ñ·¥õ ·¥Ä…¥ ·¥Ä·¥Ñ·¥õ…™·¥è…¥:")
        try:
            bot.edit_message_text(
                chat_id=user_id,
                message_id=call.message.message_id,
                text=text,
                reply_markup=admin_user_keyboard()
            )
        except:
            bot.send_message(user_id, text, reply_markup=admin_user_keyboard())

    def show_admin_bot_control(bot, call):
        user_id = call.message.chat.id
        bot_status = "üü¢ ON" if is_bot_accepting_orders() else "üî¥ OFF"
        text = style_text(f"‚öôÔ∏è B·¥è·¥õ C·¥è…¥·¥õ Ä·¥è ü\n\nC·¥ú Ä Ä·¥á…¥·¥õ S·¥õ·¥Ä·¥õ·¥ús: {bot_status}\n\nS·¥á ü·¥á·¥Ñ·¥õ ·¥Ä…¥ ·¥Ä·¥Ñ·¥õ…™·¥è…¥:")
        try:
            bot.edit_message_text(
                chat_id=user_id,
                message_id=call.message.message_id,
                text=text,
                reply_markup=admin_bot_control_keyboard()
            )
        except:
            bot.send_message(user_id, text, reply_markup=admin_bot_control_keyboard())

    def show_admin_stats(bot, call):
        user_id = call.message.chat.id
        total_users = get_total_users()
        total_orders = get_total_orders()
        total_deposit = get_total_deposits()
        active_services = len(services.get_all_services())
        
        text = style_text(f"""
üìä A·¥Ö·¥ç…™…¥ S·¥õ·¥Ä·¥õ…™s·¥õ…™·¥Ñs

üë§ T·¥è·¥õ·¥Ä ü Us·¥á Äs: {total_users}
üõí T·¥è·¥õ·¥Ä ü O Ä·¥Ö·¥á Äs: {total_orders}
üì± A·¥Ñ·¥õ…™·¥†·¥á S·¥á Ä·¥†…™·¥Ñ·¥ás: {active_services}
üí∞ T·¥è·¥õ·¥Ä ü D·¥á·¥ò·¥ès…™·¥õs: ‚Çπ{total_deposit:.2f}
        """)
        
        try:
            bot.edit_message_text(
                chat_id=user_id,
                message_id=call.message.message_id,
                text=text,
                reply_markup=admin_main_keyboard()
            )
        except:
            bot.send_message(user_id, text, reply_markup=admin_main_keyboard())

    # Service Management Functions
    def start_add_service(bot, call):
        user_id = call.message.chat.id
        admin_states[user_id] = {"action": "adding_service", "step": "category"}
        
        text = style_text("üì± A·¥Ö·¥Ö N·¥á·¥° S·¥á Ä·¥†…™·¥Ñ·¥á\n\nE…¥·¥õ·¥á Ä ·¥Ñ·¥Ä·¥õ·¥á…¢·¥è Ä è …¥·¥Ä·¥ç·¥á:")
        bot.send_message(user_id, text)
        bot.register_next_step_handler(call.message, process_add_service_category)

    def process_add_service_category(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "adding_service":
            return
        
        admin_states[user_id]["category"] = message.text.strip()
        admin_states[user_id]["step"] = "name"
        
        bot.send_message(user_id, style_text("üì± E…¥·¥õ·¥á Ä s·¥á Ä·¥†…™·¥Ñ·¥á …¥·¥Ä·¥ç·¥á:"))

    def process_add_service_name(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "adding_service":
            return
        
        admin_states[user_id]["name"] = message.text.strip()
        admin_states[user_id]["step"] = "description"
        
        bot.send_message(user_id, style_text("üìù E…¥·¥õ·¥á Ä s·¥á Ä·¥†…™·¥Ñ·¥á ·¥Ö·¥ás·¥Ñ Ä…™·¥ò·¥õ…™·¥è…¥:"))

    def process_add_service_description(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "adding_service":
            return
        
        admin_states[user_id]["description"] = message.text.strip()
        admin_states[user_id]["step"] = "min_quantity"
        
        bot.send_message(user_id, style_text("üî¢ E…¥·¥õ·¥á Ä ·¥ç…™…¥…™·¥ç·¥ú·¥ç «´·¥ú·¥Ä…¥·¥õ…™·¥õ è:"))

    def process_add_service_min_quantity(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "adding_service":
            return
        
        try:
            min_quantity = int(message.text.strip())
            admin_states[user_id]["min_quantity"] = min_quantity
            admin_states[user_id]["step"] = "max_quantity"
            
            bot.send_message(user_id, style_text("üî¢ E…¥·¥õ·¥á Ä ·¥ç·¥Äx…™·¥ç·¥ú·¥ç «´·¥ú·¥Ä…¥·¥õ…™·¥õ è:"))
        except ValueError:
            bot.send_message(user_id, style_text("‚ùå I…¥·¥†·¥Ä ü…™·¥Ö «´·¥ú·¥Ä…¥·¥õ…™·¥õ è! Us·¥á …¥·¥ú·¥ç ô·¥á Äs ·¥è…¥ ü è."))

    def process_add_service_max_quantity(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "adding_service":
            return
        
        try:
            max_quantity = int(message.text.strip())
            admin_states[user_id]["max_quantity"] = max_quantity
            admin_states[user_id]["step"] = "unit"
            
            bot.send_message(user_id, style_text("üì¶ E…¥·¥õ·¥á Ä ·¥ú…¥…™·¥õ (100 ·¥è Ä 1000):"))
        except ValueError:
            bot.send_message(user_id, style_text("‚ùå I…¥·¥†·¥Ä ü…™·¥Ö «´·¥ú·¥Ä…¥·¥õ…™·¥õ è! Us·¥á …¥·¥ú·¥ç ô·¥á Äs ·¥è…¥ ü è."))

    def process_add_service_unit(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "adding_service":
            return
        
        try:
            unit = int(message.text.strip())
            if unit not in [100, 1000]:
                bot.send_message(user_id, style_text("‚ùå U…¥…™·¥õ ·¥ç·¥ús·¥õ  ô·¥á 100 ·¥è Ä 1000!"))
                return
            
            admin_states[user_id]["unit"] = unit
            admin_states[user_id]["step"] = "price"
            
            bot.send_message(user_id, style_text("üí∞ E…¥·¥õ·¥á Ä ·¥ò Ä…™·¥Ñ·¥á ·¥ò·¥á Ä ·¥ú…¥…™·¥õ (…™…¥ ·¥ò·¥è…™…¥·¥õs):"))
        except ValueError:
            bot.send_message(user_id, style_text("‚ùå I…¥·¥†·¥Ä ü…™·¥ë ·¥ú…¥…™·¥õ! Us·¥á …¥·¥ú·¥ç ô·¥á Äs ·¥è…¥ ü è."))

    def process_add_service_price(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "adding_service":
            return
        
        try:
            price = int(message.text.strip())
            admin_states[user_id]["price"] = price
            admin_states[user_id]["step"] = "service_id"
            
            bot.send_message(user_id, style_text("üÜî E…¥·¥õ·¥á Ä s·¥á Ä·¥†…™·¥Ñ·¥á ID (API s·¥á Ä·¥†…™·¥Ñ·¥á ID):"))
        except ValueError:
            bot.send_message(user_id, style_text("‚ùå I…¥·¥†·¥Ä ü…™·¥Ö ·¥ò Ä…™·¥Ñ·¥á! Us·¥á …¥·¥ú·¥ç ô·¥á Äs ·¥è…¥ ü è."))

    def process_add_service_id(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "adding_service":
            return
        
        service_id = message.text.strip()
        admin_states[user_id]["service_id"] = service_id
        
        # Save the service
        data = admin_states[user_id]
        service_data = {
            "category": data["category"],
            "name": data["name"],
            "description": data.get("description", ""),
            "min": data.get("min_quantity", 100),
            "max": data.get("max_quantity", 1000),
            "unit": data.get("unit", 100),
            "price_per_unit": data.get("price", 10),
            "service_id": service_id,
            "active": True
        }
        
        # Add service to memory
        new_id = services.add_service(service_data)
        
        # Clear state
        del admin_states[user_id]
        
        text = style_text(f"""
‚úÖ S·¥á Ä·¥†…™·¥Ñ·¥á A·¥Ö·¥Ö·¥á·¥Ö S·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü ü è!

üì± C·¥Ä·¥õ·¥á…¢·¥è Ä è: {service_data['category']}
üì± N·¥Ä·¥ç·¥á: {service_data['name']}
üìù D·¥ás·¥Ñ Ä…™·¥ò·¥õ…™·¥è…¥: {service_data['description']}
üî¢ Q·¥ú·¥Ä…¥·¥õ…™·¥õ è: {service_data['min']}-{service_data['max']}
üì¶ U…¥…™·¥õ: {service_data['unit']}
üí∞ P Ä…™·¥Ñ·¥á: {service_data['price_per_unit']} ·¥ò·¥è…™…¥·¥õs/·¥ú…¥…™·¥õ
üÜî S·¥á Ä·¥†…™·¥Ñ·¥á ID: {service_data['service_id']}
        """)
        
        bot.send_message(user_id, text, reply_markup=admin_main_keyboard())
        log_admin_action(user_id, "add_service", f"Service: {service_data['name']}")

    def show_services_for_edit(bot, call):
        user_id = call.message.chat.id
        text = style_text("‚úèÔ∏è S·¥á ü·¥á·¥Ñ·¥õ s·¥á Ä·¥†…™·¥Ñ·¥á ·¥õ·¥è ·¥á·¥Ö…™·¥õ:")
        try:
            bot.edit_message_text(
                chat_id=user_id,
                message_id=call.message.message_id,
                text=text,
                reply_markup=services_list_keyboard("edit")
            )
        except:
            bot.send_message(user_id, text, reply_markup=services_list_keyboard("edit"))

    def show_services_for_delete(bot, call):
        user_id = call.message.chat.id
        text = style_text("‚ùå S·¥á ü·¥á·¥Ñ·¥õ s·¥á Ä·¥†…™·¥Ñ·¥á ·¥õ·¥è ·¥Ö·¥á ü·¥á·¥õ·¥á:")
        try:
            bot.edit_message_text(
                chat_id=user_id,
                message_id=call.message.message_id,
                text=text,
                reply_markup=services_list_keyboard("delete")
            )
        except:
            bot.send_message(user_id, text, reply_markup=services_list_keyboard("delete"))

    def start_edit_service(bot, call, service_id):
        user_id = call.message.chat.id
        service = services.get_service_by_id(service_id)
        
        if not service:
            bot.answer_callback_query(call.id, style_text("‚ùå S·¥á Ä·¥†…™·¥Ñ·¥á …¥·¥è·¥õ “ì·¥è·¥ú…¥·¥Ö!"))
            return
        
        admin_states[user_id] = {
            "action": "editing_service",
            "service_id": service_id,
            "service": service
        }
        
        text = style_text(f"""
‚úèÔ∏è E·¥Ö…™·¥õ S·¥á Ä·¥†…™·¥Ñ·¥á: {service['name']}

R·¥á·¥ò ü è ·¥°…™·¥õ ú ·¥õ ú·¥á “ì…™·¥á ü·¥Ö  è·¥è·¥ú ·¥°·¥Ä…¥·¥õ ·¥õ·¥è ·¥á·¥Ö…™·¥õ:
1. N·¥Ä·¥ç·¥á
2. D·¥ás·¥Ñ Ä…™·¥ò·¥õ…™·¥è…¥
3. M…™…¥ Q·¥ú·¥Ä…¥·¥õ…™·¥õ è
4. M·¥Äx Q·¥ú·¥Ä…¥·¥õ…™·¥õ è
5. U…¥…™·¥õ
6. P Ä…™·¥Ñ·¥á
7. S·¥á Ä·¥†…™·¥Ñ·¥á ID

R·¥á·¥ò ü è ·¥°…™·¥õ ú …¥·¥ú·¥ç ô·¥á Ä (1-7):
        """)
        
        bot.send_message(user_id, text)
        bot.register_next_step_handler(call.message, process_edit_service_field)

    def process_edit_service_field(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "editing_service":
            return
        
        try:
            field_num = int(message.text.strip())
            field_map = {
                1: "name", 2: "description", 3: "min", 
                4: "max", 5: "unit", 6: "price_per_unit", 7: "service_id"
            }
            
            if field_num not in field_map:
                bot.send_message(user_id, style_text("‚ùå I…¥·¥†·¥Ä ü…™·¥Ö “ì…™·¥á ü·¥Ö …¥·¥ú·¥ç ô·¥á Ä! Us·¥á 1-7."))
                return
            
            admin_states[user_id]["edit_field"] = field_map[field_num]
            
            field_names = {
                "name": "name", "description": "description", 
                "min": "minimum quantity", "max": "maximum quantity",
                "unit": "unit", "price_per_unit": "price per unit", 
                "service_id": "service ID"
            }
            
            bot.send_message(user_id, style_text(f"üì± E…¥·¥õ·¥á Ä …¥·¥á·¥° {field_names[field_map[field_num]]}:"))
            bot.register_next_step_handler(message, process_edit_service_value)
            
        except ValueError:
            bot.send_message(user_id, style_text("‚ùå I…¥·¥†·¥Ä ü…™·¥Ö …™…¥·¥ò·¥ú·¥õ! Us·¥á …¥·¥ú·¥ç ô·¥á Äs 1-7."))

    def process_edit_service_value(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "editing_service":
            return
        
        data = admin_states[user_id]
        new_value = message.text.strip()
        field = data["edit_field"]
        service_id = data["service_id"]
        
        # Validate numeric fields
        if field in ["min", "max", "unit", "price_per_unit"]:
            try:
                new_value = int(new_value)
            except ValueError:
                bot.send_message(user_id, style_text("‚ùå I…¥·¥†·¥Ä ü…™·¥Ö …¥·¥ú·¥ç ô·¥á Ä “ì·¥è Ä·¥ç·¥Ä·¥õ!"))
                return
        
        # Update service
        updates = {field: new_value}
        if services.update_service(service_id, updates):
            # Clear state
            del admin_states[user_id]
            
            bot.send_message(user_id, style_text(f"‚úÖ S·¥á Ä·¥†…™·¥Ñ·¥á {field} ·¥ú·¥ò·¥Ö·¥Ä·¥õ·¥á·¥Ö s·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü ü è!"), 
                            reply_markup=admin_main_keyboard())
            
            log_admin_action(user_id, "edit_service", f"Service ID: {service_id}, Field: {field}")
        else:
            bot.send_message(user_id, style_text("‚ùå F·¥Ä…™ ü·¥á·¥Ö ·¥õ·¥è ·¥ú·¥ò·¥Ö·¥Ä·¥õ·¥á s·¥á Ä·¥†…™·¥Ñ·¥á!"))

    def confirm_delete_service(bot, call, service_id):
        user_id = call.message.chat.id
        service = services.get_service_by_id(service_id)
        
        if not service:
            bot.answer_callback_query(call.id, style_text("‚ùå S·¥á Ä·¥†…™·¥Ñ·¥á …¥·¥è·¥õ “ì·¥è·¥ú…¥·¥Ö!"))
            return
        
        text = style_text(f"""
‚ùå C·¥è…¥“ì…™ Ä·¥ç D·¥á ü·¥á·¥õ…™·¥è…¥

A Ä·¥á  è·¥è·¥ú s·¥ú Ä·¥á  è·¥è·¥ú ·¥°·¥Ä…¥·¥õ ·¥õ·¥è ·¥Ö·¥á ü·¥á·¥õ·¥á ·¥õ ú…™s s·¥á Ä·¥†…™·¥Ñ·¥á?

üì± S·¥á Ä·¥†…™·¥Ñ·¥á: {service['name']}
üìÇ C·¥Ä·¥õ·¥á…¢·¥è Ä è: {service['category']}
üí∞ P Ä…™·¥Ñ·¥á: {service['price_per_unit']} ·¥ò·¥è…™…¥·¥õs

T ú…™s ·¥Ä·¥Ñ·¥õ…™·¥è…¥ ·¥Ñ·¥Ä…¥…¥·¥è·¥õ  ô·¥á ·¥ú…¥·¥Ö·¥è…¥·¥á!
        """)
        
        try:
            bot.edit_message_text(
                chat_id=user_id,
                message_id=call.message.message_id,
                text=text,
                reply_markup=confirm_delete_keyboard(service_id)
            )
        except:
            bot.send_message(user_id, text, reply_markup=confirm_delete_keyboard(service_id))

    def delete_service_handler(bot, call, service_id):
        user_id = call.message.chat.id
        service = services.get_service_by_id(service_id)
        
        if not service:
            bot.answer_callback_query(call.id, style_text("‚ùå S·¥á Ä·¥†…™·¥Ñ·¥á …¥·¥è·¥õ “ì·¥è·¥ú…¥·¥Ö!"))
            return
        
        service_name = service['name']
        if services.delete_service(service_id):
            text = style_text(f"‚úÖ S·¥á Ä·¥†…™·¥Ñ·¥á '{service_name}' ·¥Ö·¥á ü·¥á·¥õ·¥á·¥Ö s·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü ü è!")
            
            try:
                bot.edit_message_text(
                    chat_id=user_id,
                    message_id=call.message.message_id,
                    text=text,
                    reply_markup=admin_main_keyboard()
                )
            except:
                bot.send_message(user_id, text, reply_markup=admin_main_keyboard())
            
            log_admin_action(user_id, "delete_service", f"Service: {service_name}")
        else:
            bot.answer_callback_query(call.id, style_text("‚ùå F·¥Ä…™ ü·¥á·¥Ö ·¥õ·¥è ·¥Ö·¥á ü·¥á·¥õ·¥á s·¥á Ä·¥†…™·¥Ñ·¥á!"), show_alert=True)

    def start_admin_broadcast(bot, call):
        user_id = call.message.chat.id
        admin_states[user_id] = {"action": "broadcasting", "step": "message"}
        
        text = style_text("üì¢ B Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ\n\nS·¥á…¥·¥Ö ·¥õ ú·¥á ·¥ç·¥áss·¥Ä…¢·¥á  è·¥è·¥ú ·¥°·¥Ä…¥·¥õ ·¥õ·¥è  ô Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ ·¥õ·¥è ·¥Ä ü ü ·¥ús·¥á Äs:")
        bot.send_message(user_id, text)

    def process_broadcast_message(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "broadcasting":
            return
        
        broadcast_message = message.text
        admin_states[user_id]["broadcast_message"] = broadcast_message
        
        text = style_text(f"""
üì¢ B Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ C·¥è…¥“ì…™ Ä·¥ç·¥Ä·¥õ…™·¥è…¥

M·¥áss·¥Ä…¢·¥á:
{broadcast_message}

T ú…™s ·¥ç·¥áss·¥Ä…¢·¥á ·¥°…™ ü ü  ô·¥á s·¥á…¥·¥õ ·¥õ·¥è ·¥Ä ü ü ·¥ús·¥á Äs. C·¥è…¥“ì…™ Ä·¥ç?
        """)
        
        bot.send_message(user_id, text, reply_markup=broadcast_confirmation_keyboard())

    def confirm_broadcast(bot, call):
        user_id = call.message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "broadcasting":
            return
        
        message_text = admin_states[user_id].get("broadcast_message")
        if not message_text:
            bot.answer_callback_query(call.id, style_text("‚ùå N·¥è ·¥ç·¥áss·¥Ä…¢·¥á “ì·¥è·¥ú…¥·¥Ö!"), show_alert=True)
            return
        
        # Send broadcast
        if users_collection:
            users = users_collection.find({})
            success_count = 0
            fail_count = 0
            
            for user in users:
                try:
                    bot.send_message(user["user_id"], style_text(f"üì¢ A…¥…¥·¥è·¥ú…¥·¥Ñ·¥á·¥ç·¥á…¥·¥õ:\n\n{message_text}"))
                    success_count += 1
                    time.sleep(0.1)  # Rate limiting
                except Exception as e:
                    fail_count += 1
            
            report = style_text(f"""
üì¢ B Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ R·¥á·¥ò·¥è Ä·¥õ

‚úÖ S·¥ú·¥Ñ·¥Ñ·¥áss: {success_count}
‚ùå F·¥Ä…™ ü·¥á·¥Ö: {fail_count}
üìä T·¥è·¥õ·¥Ä ü: {success_count + fail_count}
            """)
        else:
            report = style_text("‚ùå D·¥Ä·¥õ·¥Ä ô·¥Äs·¥á …¥·¥è·¥õ ·¥Ä·¥†·¥Ä…™ ü·¥Ä ô ü·¥á “ì·¥è Ä  ô Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ")
        
        bot.send_message(user_id, report, reply_markup=admin_main_keyboard())
        del admin_states[user_id]
        log_admin_action(user_id, "broadcast", f"Message: {message_text[:50]}...")

    def start_add_balance(bot, call):
        user_id = call.message.chat.id
        admin_states[user_id] = {"action": "adding_balance", "step": "user_id"}
        
        text = style_text("üí∞ A·¥Ö·¥Ö B·¥Ä ü·¥Ä…¥·¥Ñ·¥á\n\nS·¥á…¥·¥Ö Us·¥á Ä ID:")
        bot.send_message(user_id, text)

    def process_add_balance_user_id(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "adding_balance":
            return
        
        try:
            target_user_id = int(message.text.strip())
            admin_states[user_id]["target_user_id"] = target_user_id
            admin_states[user_id]["step"] = "amount"
            
            bot.send_message(user_id, style_text("üí∞ E…¥·¥õ·¥á Ä ·¥Ä·¥ç·¥è·¥ú…¥·¥õ ·¥õ·¥è ·¥Ä·¥Ö·¥Ö (…™…¥ ·¥ò·¥è…™…¥·¥õs):"))
        except ValueError:
            bot.send_message(user_id, style_text("‚ùå I…¥·¥†·¥Ä ü…™·¥Ö Us·¥á Ä ID! Us·¥á …¥·¥ú·¥ç ô·¥á Äs ·¥è…¥ ü è."))

    def process_add_balance_amount(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "adding_balance":
            return
        
        try:
            amount = int(message.text.strip())
            target_user_id = admin_states[user_id]["target_user_id"]
            
            # Add balance
            new_balance = update_user_balance(target_user_id, amount, is_deposit=True)
            
            # Clear state
            del admin_states[user_id]
            
            text = style_text(f"""
‚úÖ B·¥Ä ü·¥Ä…¥·¥Ñ·¥á A·¥Ö·¥Ö·¥á·¥Ö S·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü ü è!

üë§ Us·¥á Ä ID: {target_user_id}
üí∞ A·¥ç·¥è·¥ú…¥·¥õ A·¥Ö·¥Ö·¥á·¥Ö: {amount} ·¥ò·¥è…™…¥·¥õs
üí≥ N·¥á·¥° B·¥Ä ü·¥Ä…¥·¥Ñ·¥á: {new_balance} ·¥ò·¥è…™…¥·¥õs
            """)
            
            bot.send_message(user_id, text, reply_markup=admin_main_keyboard())
            log_admin_action(user_id, "add_balance", f"User: {target_user_id}, Amount: {amount}")
            
        except ValueError:
            bot.send_message(user_id, style_text("‚ùå I…¥·¥†·¥Ä ü…™·¥Ö ·¥Ä·¥ç·¥è·¥ú…¥·¥õ! Us·¥á …¥·¥ú·¥ç ô·¥á Äs ·¥è…¥ ü è."))

    def start_deduct_balance(bot, call):
        user_id = call.message.chat.id
        admin_states[user_id] = {"action": "deducting_balance", "step": "user_id"}
        
        text = style_text("üí∞ D·¥á·¥Ö·¥ú·¥Ñ·¥õ B·¥Ä ü·¥Ä…¥·¥Ñ·¥á\n\nS·¥á…¥·¥Ö Us·¥á Ä ID:")
        bot.send_message(user_id, text)

    def process_deduct_balance_user_id(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "deducting_balance":
            return
        
        try:
            target_user_id = int(message.text.strip())
            admin_states[user_id]["target_user_id"] = target_user_id
            admin_states[user_id]["step"] = "amount"
            
            bot.send_message(user_id, style_text("üí∞ E…¥·¥õ·¥á Ä ·¥Ä·¥ç·¥è·¥ú…¥·¥õ ·¥õ·¥è ·¥Ö·¥á·¥Ö·¥ú·¥Ñ·¥õ (…™…¥ ·¥ò·¥è…™…¥·¥õs):"))
        except ValueError:
            bot.send_message(user_id, style_text("‚ùå I…¥·¥†·¥Ä ü…™·¥Ö Us·¥á Ä ID! Us·¥á …¥·¥ú·¥ç ô·¥á Äs ·¥è…¥ ü è."))

    def process_deduct_balance_amount(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "deducting_balance":
            return
        
        try:
            amount = int(message.text.strip())
            target_user_id = admin_states[user_id]["target_user_id"]
            
            # Check if user has sufficient balance
            current_balance = get_user(target_user_id)["balance_points"]
            if current_balance < amount:
                bot.send_message(user_id, style_text(f"‚ùå I…¥s·¥ú“ì“ì…™·¥Ñ…™·¥á…¥·¥õ  ô·¥Ä ü·¥Ä…¥·¥Ñ·¥á! Us·¥á Ä  ú·¥Äs ·¥è…¥ ü è {current_balance} ·¥ò·¥è…™…¥·¥õs."))
                return
            
            # Deduct balance
            new_balance = update_user_balance(target_user_id, -amount, is_spent=True)
            
            # Clear state
            del admin_states[user_id]
            
            text = style_text(f"""
‚úÖ B·¥Ä ü·¥Ä…¥·¥Ñ·¥á D·¥á·¥Ö·¥ú·¥Ñ·¥õ·¥á·¥Ö S·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü ü è!

üë§ Us·¥á Ä ID: {target_user_id}
üí∞ A·¥ç·¥è·¥ú…¥·¥õ D·¥á·¥Ö·¥ú·¥Ñ·¥õ·¥á·¥Ö: {amount} ·¥ò·¥è…™…¥·¥õs
üí≥ N·¥á·¥° B·¥Ä ü·¥Ä…¥·¥Ñ·¥á: {new_balance} ·¥ò·¥è…™…¥·¥õs
            """)
            
            bot.send_message(user_id, text, reply_markup=admin_main_keyboard())
            log_admin_action(user_id, "deduct_balance", f"User: {target_user_id}, Amount: {amount}")
            
        except ValueError:
            bot.send_message(user_id, style_text("‚ùå I…¥·¥†·¥Ä ü…™·¥Ö ·¥Ä·¥ç·¥è·¥ú…¥·¥õ! Us·¥á …¥·¥ú·¥ç ô·¥á Äs ·¥è…¥ ü è."))

    def start_ban_user(bot, call):
        user_id = call.message.chat.id
        admin_states[user_id] = {"action": "banning_user", "step": "user_id"}
        
        text = style_text("üî® B·¥Ä…¥ Us·¥á Ä\n\nS·¥á…¥·¥Ö Us·¥á Ä ID ·¥õ·¥è  ô·¥Ä…¥:")
        bot.send_message(user_id, text)

    def process_ban_user(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "banning_user":
            return
        
        try:
            target_user_id = int(message.text.strip())
            
            # Ban user
            if users_collection:
                users_collection.update_one(
                    {"user_id": target_user_id},
                    {"$set": {"banned": True}},
                    upsert=True
                )
            
            # Clear state
            del admin_states[user_id]
            
            text = style_text(f"""
‚úÖ Us·¥á Ä B·¥Ä…¥…¥·¥á·¥Ö S·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü ü è!

üë§ Us·¥á Ä ID: {target_user_id}
üî® S·¥õ·¥Ä·¥õ·¥ús: B·¥Ä…¥…¥·¥á·¥Ö
            """)
            
            bot.send_message(user_id, text, reply_markup=admin_main_keyboard())
            log_admin_action(user_id, "ban_user", f"User: {target_user_id}")
            
        except ValueError:
            bot.send_message(user_id, style_text("‚ùå I…¥·¥†·¥Ä ü…™·¥Ö Us·¥á Ä ID! Us·¥á …¥·¥ú·¥ç ô·¥á Äs ·¥è…¥ ü è."))

    def start_unban_user(bot, call):
        user_id = call.message.chat.id
        admin_states[user_id] = {"action": "unbanning_user", "step": "user_id"}
        
        text = style_text("‚úÖ U…¥ ô·¥Ä…¥ Us·¥á Ä\n\nS·¥á…¥·¥Ö Us·¥á Ä ID ·¥õ·¥è ·¥ú…¥ ô·¥Ä…¥:")
        bot.send_message(user_id, text)

    def process_unban_user(message):
        user_id = message.chat.id
        if user_id not in admin_states or admin_states[user_id].get("action") != "unbanning_user":
            return
        
        try:
            target_user_id = int(message.text.strip())
            
            # Unban user
            if users_collection:
                users_collection.update_one(
                    {"user_id": target_user_id},
                    {"$set": {"banned": False}}
                )
            
            # Clear state
            del admin_states[user_id]
            
            text = style_text(f"""
‚úÖ Us·¥á Ä U…¥ ô·¥Ä…¥…¥·¥á·¥Ö S·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü ü è!

üë§ Us·¥á Ä ID: {target_user_id}
‚úÖ S·¥õ·¥Ä·¥õ·¥ús: A·¥Ñ·¥õ…™·¥†·¥á
            """)
            
            bot.send_message(user_id, text, reply_markup=admin_main_keyboard())
            log_admin_action(user_id, "unban_user", f"User: {target_user_id}")
            
        except ValueError:
            bot.send_message(user_id, style_text("‚ùå I…¥·¥†·¥Ä ü…™·¥Ö Us·¥á Ä ID! Us·¥á …¥·¥ú·¥ç ô·¥á Äs ·¥è…¥ ü è."))

    def set_bot_status(bot, call, status):
        user_id = call.message.chat.id
        set_bot_accepting_orders(status)
        
        status_text = "üü¢ ON" if status else "üî¥ OFF"
        text = style_text(f"‚úÖ B·¥è·¥õ s·¥õ·¥Ä·¥õ·¥ús s·¥á·¥õ ·¥õ·¥è: {status_text}")
        
        try:
            bot.edit_message_text(
                chat_id=user_id,
                message_id=call.message.message_id,
                text=text,
                reply_markup=admin_main_keyboard()
            )
        except:
            bot.send_message(user_id, text, reply_markup=admin_main_keyboard())
        
        log_admin_action(user_id, "set_bot_status", f"Status: {status_text}")

    def show_bot_status(bot, call):
        user_id = call.message.chat.id
        bot_status = "üü¢ ON" if is_bot_accepting_orders() else "üî¥ OFF"
        
        text = style_text(f"‚öôÔ∏è C·¥ú Ä Ä·¥á…¥·¥õ B·¥è·¥õ S·¥õ·¥Ä·¥õ·¥ús: {bot_status}")
        
        bot.answer_callback_query(call.id, text, show_alert=True)

    return bot
