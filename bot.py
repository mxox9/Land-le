import telebot
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton
import requests
import time
from datetime import datetime
import threading
from pymongo import MongoClient
import os

# Bot Token
BOT_TOKEN = "8052955693:AAGoXnNg90jqvcC1X1fVo_qKV8Y0eHjDAZg"
bot = telebot.TeleBot(BOT_TOKEN)

# MongoDB Setup
MONGO_URI = "mongodb+srv://saifulmolla79088179_db_user:17gNrX0pC3bPqVaG@cluster0.fusvqca.mongodb.net/test?retryWrites=true&w=majority&appName=Cluster0"  # Change to your MongoDB URI
client = MongoClient(MONGO_URI)
db = client.telegram_bot
users_collection = db.users
orders_collection = db.orders
services_collection = db.services
admin_collection = db.admin

# Admin Configuration
ADMIN_ID = 6052975324  # Your Telegram ID
ADMIN_PASSWORD = "SmOx9679"

# SMM Panel API
SMM_API_KEY = "a9bbe2f7d1a748b62cf5d1e195d06a165e3cc36d"

# Initialize default services if not exists
default_services = [
    {
        "category": "instagram",
        "name": "Instagram Followers",
        "service_id": "4679",
        "price_per_100": 1000,
        "min": 100,
        "max": 300000,
        "description": "‚ú® H…™…¢ ú-Q·¥ú·¥Ä ü…™·¥õ è F·¥è ü ü·¥è·¥°·¥á Äs ‚ú®"
    },
    {
        "category": "instagram", 
        "name": "Instagram Likes",
        "service_id": "4961",
        "price_per_100": 250,
        "min": 100,
        "max": 100000,
        "description": "‚ù§Ô∏è F·¥Äs·¥õ L…™·¥ã·¥ás D·¥á ü…™·¥†·¥á Ä è ‚ù§Ô∏è"
    },
    {
        "category": "instagram",
        "name": "Instagram Reel Views", 
        "service_id": "3411",
        "price_per_1000": 250,
        "min": 5000,
        "max": 1000000,
        "description": "üöÄ U ü·¥õ Ä·¥Ä F·¥Äs·¥õ R·¥á·¥á ü V…™·¥á·¥°s üöÄ"
    }
]

if services_collection.count_documents({}) == 0:
    services_collection.insert_many(default_services)

# User states for conversation handling
user_states = {}

def get_user_balance(user_id):
    user = users_collection.find_one({"user_id": user_id})
    if user:
        return user.get('balance', 0)
    else:
        users_collection.insert_one({
            "user_id": user_id,
            "balance": 0,
            "total_orders": 0,
            "total_deposits": 0,
            "joined_date": datetime.now()
        })
        return 0

def update_user_balance(user_id, amount):
    current_balance = get_user_balance(user_id)
    new_balance = current_balance + amount
    users_collection.update_one(
        {"user_id": user_id},
        {"$set": {"balance": new_balance}}
    )
    return new_balance

def create_order(user_id, service_name, link, quantity, cost, order_id):
    order_data = {
        "user_id": user_id,
        "service_name": service_name,
        "link": link,
        "quantity": quantity,
        "cost": cost,
        "order_id": order_id,
        "status": "In Progress",
        "created_at": datetime.now(),
        "updated_at": datetime.now()
    }
    orders_collection.insert_one(order_data)
    
    # Update user's total orders
    users_collection.update_one(
        {"user_id": user_id},
        {"$inc": {"total_orders": cost}}
    )

def get_user_orders(user_id):
    return list(orders_collection.find({"user_id": user_id}).sort("created_at", -1))

def get_service_by_name(service_name):
    return services_collection.find_one({"name": service_name})

# Auto-refund system
def check_orders_status():
    while True:
        try:
            # Get orders that are in progress
            in_progress_orders = orders_collection.find({"status": "In Progress"})
            
            for order in in_progress_orders:
                # Check order status from SMM API (simplified)
                # In real implementation, you'd call your SMM panel API
                time.sleep(2)  # Prevent API rate limiting
                
            time.sleep(300)  # Check every 5 minutes
        except Exception as e:
            print(f"Error in auto-refund system: {e}")
            time.sleep(60)

# Start auto-refund thread
refund_thread = threading.Thread(target=check_orders_status, daemon=True)
refund_thread.start()

# Text styling function
def style_text(text):
    words = text.split()
    styled_words = []
    for word in words:
        if word:
            styled_words.append(word[0].upper() + word[1:].lower())
        else:
            styled_words.append(word)
    return ' '.join(styled_words)

# Main menu inline keyboard
def main_menu_keyboard():
    markup = InlineKeyboardMarkup()
    markup.row_width = 2
    markup.add(
        InlineKeyboardButton("üí∞ D·¥á·¥ò·¥ès…™·¥õ", callback_data="deposit"),
        InlineKeyboardButton("üõí O Ä·¥Ö·¥á Ä", callback_data="order_menu")
    )
    markup.add(
        InlineKeyboardButton("üìã H…™s·¥õ·¥è Ä è", callback_data="history"),
        InlineKeyboardButton("üë• R·¥á“ì·¥á Ä", callback_data="refer")
    )
    return markup

# Service category keyboard
def service_category_keyboard():
    markup = InlineKeyboardMarkup()
    markup.row_width = 2
    markup.add(
        InlineKeyboardButton("üì∑ I…¥s·¥õ·¥Ä…¢ Ä·¥Ä·¥ç", callback_data="service_instagram"),
        InlineKeyboardButton("üìò F·¥Ä·¥Ñ·¥á ô·¥è·¥è·¥ã", callback_data="service_facebook")
    )
    markup.add(
        InlineKeyboardButton("üì∫ Y·¥è·¥ú·¥õ·¥ú ô·¥á", callback_data="service_youtube"),
        InlineKeyboardButton("‚úàÔ∏è T·¥á ü·¥á…¢ Ä·¥Ä·¥ç", callback_data="service_telegram")
    )
    markup.add(InlineKeyboardButton("üîô B·¥Ä·¥Ñ·¥ã", callback_data="main_menu"))
    return markup

# Instagram services keyboard
def instagram_services_keyboard():
    markup = InlineKeyboardMarkup()
    instagram_services = services_collection.find({"category": "instagram"})
    
    for service in instagram_services:
        markup.add(InlineKeyboardButton(
            f"‚ú® {service['name']}", 
            callback_data=f"order_{service['name']}"
        ))
    
    markup.add(InlineKeyboardButton("üîô B·¥Ä·¥Ñ·¥ã", callback_data="order_menu"))
    return markup

# Admin keyboard
def admin_keyboard():
    markup = InlineKeyboardMarkup()
    markup.row_width = 2
    markup.add(
        InlineKeyboardButton("üë• M·¥Ä…¥·¥Ä…¢·¥á Us·¥á Äs", callback_data="admin_users"),
        InlineKeyboardButton("üõ† M·¥Ä…¥·¥Ä…¢·¥á S·¥á Ä·¥†…™·¥Ñ·¥ás", callback_data="admin_services")
    )
    markup.add(
        InlineKeyboardButton("üìä B·¥è·¥õ S·¥õ·¥Ä·¥õs", callback_data="admin_stats"),
        InlineKeyboardButton("üì¢ B Ä·¥è·¥Ä·¥Ö·¥Ñ·¥Äs·¥õ", callback_data="admin_broadcast")
    )
    markup.add(InlineKeyboardButton("‚öôÔ∏è B·¥è·¥õ S·¥á·¥õ·¥õ…™…¥…¢s", callback_data="admin_settings"))
    return markup

# Start command
@bot.message_handler(commands=['start'])
def send_welcome(message):
    user_id = message.chat.id
    user_name = message.from_user.first_name
    
    welcome_text = f"""
‚ú® W·¥á ü·¥Ñ·¥è·¥ç·¥á {user_name}! ‚ú®

T ú…™s Is T ú·¥á M·¥ès·¥õ A·¥Ö·¥†·¥Ä…¥·¥Ñ·¥á·¥Ö SMM B·¥è·¥õ O…¥ T·¥á ü·¥á…¢ Ä·¥Ä·¥ç! üöÄ

C ú·¥è·¥ès·¥á A…¥ O·¥ò·¥õ…™·¥è…¥ F Ä·¥è·¥ç T ú·¥á M·¥á…¥·¥ú B·¥á ü·¥è·¥°:
    """
    
    bot.send_photo(
        chat_id=user_id,
        photo="https://via.placeholder.com/400x200/0088cc/ffffff?text=Welcome+To+SMM+Bot",
        caption=welcome_text,
        reply_markup=main_menu_keyboard(),
        parse_mode="HTML"
    )

# Callback query handler
@bot.callback_query_handler(func=lambda call: True)
def callback_query(call):
    user_id = call.message.chat.id
    message_id = call.message.message_id
    
    if call.data == "main_menu":
        bot.edit_message_media(
            chat_id=user_id,
            message_id=message_id,
            media=telebot.types.InputMediaPhoto(
                "https://via.placeholder.com/400x200/0088cc/ffffff?text=Main+Menu",
                caption="üè† M·¥Ä…™…¥ M·¥á…¥·¥ú - C ú·¥è·¥ès·¥á A…¥ O·¥ò·¥õ…™·¥è…¥:"
            ),
            reply_markup=main_menu_keyboard()
        )
    
    elif call.data == "deposit":
        handle_deposit(call)
    
    elif call.data == "order_menu":
        bot.edit_message_media(
            chat_id=user_id,
            message_id=message_id,
            media=telebot.types.InputMediaPhoto(
                "https://via.placeholder.com/400x200/28a745/ffffff?text=Order+Services",
                caption="üõí S·¥á ü·¥á·¥Ñ·¥õ A S·¥á Ä·¥†…™·¥Ñ·¥á C·¥Ä·¥õ·¥á…¢·¥è Ä è:"
            ),
            reply_markup=service_category_keyboard()
        )
    
    elif call.data == "history":
        handle_history(call)
    
    elif call.data == "refer":
        handle_refer(call)
    
    elif call.data == "service_instagram":
        bot.edit_message_media(
            chat_id=user_id,
            message_id=message_id,
            media=telebot.types.InputMediaPhoto(
                "https://via.placeholder.com/400x200/E4405F/ffffff?text=Instagram+Services",
                caption="üì∑ I…¥s·¥õ·¥Ä…¢ Ä·¥Ä·¥ç S·¥á Ä·¥†…™·¥Ñ·¥ás - C ú·¥è·¥ès·¥á O…¥·¥á:"
            ),
            reply_markup=instagram_services_keyboard()
        )
    
    elif call.data.startswith("order_"):
        service_name = call.data.replace("order_", "")
        user_states[user_id] = {"action": "ordering", "service_name": service_name}
        
        service = get_service_by_name(service_name)
        if service:
            price_info = ""
            if 'price_per_100' in service:
                price_info = f"üí∏ P Ä…™·¥Ñ·¥á: {service['price_per_100']} P·¥è…™…¥·¥õs P·¥á Ä 100"
            elif 'price_per_1000' in service:
                price_info = f"üí∏ P Ä…™·¥Ñ·¥á: {service['price_per_1000']} P·¥è…™…¥·¥õs P·¥á Ä 1000"
            
            service_text = f"""
‚ú® {service['name']} ‚ú®

{service['description']}

{price_info}
üî∞ M…™…¥: {service['min']} | M·¥Äx: {service['max']}

P ü·¥á·¥Äs·¥á S·¥á…¥·¥Ö T ú·¥á L…™…¥·¥ã:
            """
            
            bot.edit_message_media(
                chat_id=user_id,
                message_id=message_id,
                media=telebot.types.InputMediaPhoto(
                    "https://via.placeholder.com/400x200/17a2b8/ffffff?text=Enter+Link",
                    caption=service_text
                )
            )
            
            bot.register_next_step_handler(call.message, process_order_link)
    
    elif call.data == "check_deposit":
        handle_deposit_check(call)

# Deposit handler
def handle_deposit(call):
    user_id = call.message.chat.id
    amount = 100  # Default amount
    
    # Generate UTR
    import random
    utr = str(random.randint(100000000000, 999999999999))
    
    # Save deposit info
    user_states[user_id] = {
        "action": "deposit",
        "utr": utr,
        "amount": amount
    }
    
    deposit_text = f"""
üí∞ D·¥á·¥ò·¥ès…™·¥õ R·¥á«´·¥ú·¥ás·¥õ üí∞

A·¥ç·¥è·¥ú…¥·¥õ: ‚Çπ{amount}
UTR: {utr}

P ü·¥á·¥Äs·¥á Us·¥á T ú·¥á F·¥è ü ü·¥è·¥°…™…¥…¢ D·¥á·¥õ·¥Ä…™ üs F·¥è Ä P·¥Ä è·¥ç·¥á…¥·¥õ:

UPI ID: paytm.s1m11be@pty
A·¥ç·¥è·¥ú…¥·¥õ: ‚Çπ{amount}
N·¥è·¥õ·¥á: {utr}

A“ì·¥õ·¥á Ä P·¥Ä è·¥ç·¥á…¥·¥õ, C ü…™·¥Ñ·¥ã 'P·¥Ä…™·¥Ö ‚úÖ' B·¥á ü·¥è·¥°.
    """
    
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("üí∞ P·¥Ä…™·¥Ö ‚úÖ", callback_data="check_deposit"))
    markup.add(InlineKeyboardButton("üîô B·¥Ä·¥Ñ·¥ã", callback_data="main_menu"))
    
    bot.edit_message_media(
        chat_id=user_id,
        message_id=call.message.message_id,
        media=telebot.types.InputMediaPhoto(
            "https://via.placeholder.com/400x200/28a745/ffffff?text=Deposit+Instructions",
            caption=deposit_text
        ),
        reply_markup=markup
    )

# Deposit check handler
def handle_deposit_check(call):
    user_id = call.message.chat.id
    user_state = user_states.get(user_id, {})
    
    if user_state.get("action") == "deposit":
        amount = user_state.get("amount", 0)
        points_to_add = amount * 100  # 1 INR = 100 points
        
        # In real implementation, you'd verify payment here
        # For now, we'll simulate successful payment
        new_balance = update_user_balance(user_id, points_to_add)
        
        success_text = f"""
‚úÖ P·¥Ä è·¥ç·¥á…¥·¥õ S·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü! ‚úÖ

üí∞ A·¥ç·¥è·¥ú…¥·¥õ D·¥á·¥ò·¥ès…™·¥õ·¥á·¥Ö: ‚Çπ{amount}
üéØ P·¥è…™…¥·¥õs A·¥Ö·¥Ö·¥á·¥Ö: {points_to_add}
üè¶ N·¥á·¥° B·¥Ä ü·¥Ä…¥·¥Ñ·¥á: {new_balance} P·¥è…™…¥·¥õs

T ú·¥Ä…¥·¥ã Y·¥è·¥ú F·¥è Ä Y·¥è·¥ú Ä D·¥á·¥ò·¥ès…™·¥õ! üéâ
        """
        
        # Update user's total deposits
        users_collection.update_one(
            {"user_id": user_id},
            {"$inc": {"total_deposits": points_to_add}}
        )
        
        bot.edit_message_media(
            chat_id=user_id,
            message_id=call.message.message_id,
            media=telebot.types.InputMediaPhoto(
                "https://via.placeholder.com/400x200/28a745/ffffff?text=Payment+Success",
                caption=success_text
            ),
            reply_markup=main_menu_keyboard()
        )
        
        # Notify admin
        try:
            bot.send_message(
                ADMIN_ID,
                f"üí∞ N·¥á·¥° D·¥á·¥ò·¥ès…™·¥õ!\n\nUs·¥á Ä: {user_id}\nA·¥ç·¥è·¥ú…¥·¥õ: ‚Çπ{amount}\nP·¥è…™…¥·¥õs: {points_to_add}"
            )
        except:
            pass

# History handler
def handle_history(call):
    user_id = call.message.chat.id
    orders = get_user_orders(user_id)
    
    if not orders:
        history_text = "üì≠ N·¥è O Ä·¥Ö·¥á Ä H…™s·¥õ·¥è Ä è F·¥è·¥ú…¥·¥Ö"
    else:
        history_text = "üìã Y·¥è·¥ú Ä O Ä·¥Ö·¥á Ä H…™s·¥õ·¥è Ä è:\n\n"
        for order in orders[:10]:  # Show last 10 orders
            status_emoji = "üü¢" if order['status'] == 'Completed' else "üü°" if order['status'] == 'In Progress' else "üî¥"
            history_text += f"""
{status_emoji} S·¥á Ä·¥†…™·¥Ñ·¥á: {order['service_name']}
üî¢ Q·¥ú·¥Ä…¥·¥õ…™·¥õ è: {order['quantity']}
üí∞ C·¥ès·¥õ: {order['cost']} P·¥è…™…¥·¥õs
üÜî O Ä·¥Ö·¥á Ä ID: {order['order_id']}
üìÖ D·¥Ä·¥õ·¥á: {order['created_at'].strftime('%Y-%m-%d %H:%M')}
üìä S·¥õ·¥Ä·¥õ·¥ús: {order['status']}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            """
    
    bot.edit_message_media(
        chat_id=user_id,
        message_id=call.message.message_id,
        media=telebot.types.InputMediaPhoto(
            "https://via.placeholder.com/400x200/6f42c1/ffffff?text=Order+History",
            caption=history_text
        ),
        reply_markup=main_menu_keyboard()
    )

# Refer handler
def handle_refer(call):
    user_id = call.message.chat.id
    bot_username = bot.get_me().username
    referral_link = f"https://t.me/{bot_username}?start={user_id}"
    
    refer_text = f"""
üë• R·¥á“ì·¥á Ä & E·¥Ä Ä…¥ üë•

I…¥·¥†…™·¥õ·¥á F Ä…™·¥á…¥·¥Ös A…¥·¥Ö E·¥Ä Ä…¥ 100 P·¥è…™…¥·¥õs P·¥á Ä R·¥á“ì·¥á Ä Ä·¥Ä ü!

Y·¥è·¥ú Ä R·¥á“ì·¥á Ä Ä·¥Ä ü L…™…¥·¥ã:
{referral_link}

üîπ Y·¥è·¥ú G·¥á·¥õ: 100 P·¥è…™…¥·¥õs P·¥á Ä R·¥á“ì·¥á Ä Ä·¥Ä ü
üîπ F Ä…™·¥á…¥·¥Ö G·¥á·¥õs: 50 P·¥è…™…¥·¥õs W·¥á ü·¥Ñ·¥è·¥ç·¥á B·¥è…¥·¥ús

S ú·¥Ä Ä·¥á T ú…™s L…™…¥·¥ã W…™·¥õ ú Y·¥è·¥ú Ä F Ä…™·¥á…¥·¥Ös! üéâ
    """
    
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("üì§ S ú·¥Ä Ä·¥á L…™…¥·¥ã", url=f"tg://msg_url?text={referral_link}"))
    markup.add(InlineKeyboardButton("üîô B·¥Ä·¥Ñ·¥ã", callback_data="main_menu"))
    
    bot.edit_message_media(
        chat_id=user_id,
        message_id=call.message.message_id,
        media=telebot.types.InputMediaPhoto(
            "https://via.placeholder.com/400x200/ffc107/ffffff?text=Refer+Friends",
            caption=refer_text
        ),
        reply_markup=markup
    )

# Order processing
def process_order_link(message):
    user_id = message.chat.id
    user_state = user_states.get(user_id, {})
    
    if user_state.get("action") == "ordering":
        link = message.text
        if not link.startswith("http"):
            bot.send_message(user_id, "‚ùå I…¥·¥†·¥Ä ü…™·¥Ö L…™…¥·¥ã! P ü·¥á·¥Äs·¥á S·¥á…¥·¥Ö A V·¥Ä ü…™·¥Ö HTTP/S L…™…¥·¥ã.")
            return
        
        user_state["link"] = link
        user_states[user_id] = user_state
        
        service = get_service_by_name(user_state["service_name"])
        if service:
            bot.send_message(
                user_id,
                f"üî¢ N·¥è·¥° P ü·¥á·¥Äs·¥á E…¥·¥õ·¥á Ä T ú·¥á Q·¥ú·¥Ä…¥·¥õ…™·¥õ è:\n\nM…™…¥: {service['min']} | M·¥Äx: {service['max']}"
            )
            bot.register_next_step_handler(message, process_order_quantity)

def process_order_quantity(message):
    user_id = message.chat.id
    user_state = user_states.get(user_id, {})
    
    if user_state.get("action") == "ordering":
        try:
            quantity = int(message.text)
            service = get_service_by_name(user_state["service_name"])
            
            if not service:
                bot.send_message(user_id, "‚ùå S·¥á Ä·¥†…™·¥Ñ·¥á N·¥è·¥õ F·¥è·¥ú…¥·¥Ö!")
                return
            
            # Validate quantity
            if quantity < service['min']:
                bot.send_message(user_id, f"‚ùå Q·¥ú·¥Ä…¥·¥õ…™·¥õ è T·¥è·¥è L·¥è·¥°! M…™…¥…™·¥ç·¥ú·¥ç: {service['min']}")
                return
            
            if quantity > service['max']:
                bot.send_message(user_id, f"‚ùå Q·¥ú·¥Ä…¥·¥õ…™·¥õ è T·¥è·¥è H…™…¢ ú! M·¥Äx…™·¥ç·¥ú·¥ç: {service['max']}")
                return
            
            # Calculate cost
            if 'price_per_100' in service:
                cost = (quantity // 100) * service['price_per_100']
            elif 'price_per_1000' in service:
                cost = (quantity // 1000) * service['price_per_1000']
            else:
                cost = quantity  # Fallback
            
            user_balance = get_user_balance(user_id)
            
            if user_balance < cost:
                bot.send_message(
                    user_id,
                    f"‚ùå I…¥s·¥ú“ì“ì…™·¥Ñ…™·¥á…¥·¥õ B·¥Ä ü·¥Ä…¥·¥Ñ·¥á!\n\nY·¥è·¥ú Ä B·¥Ä ü·¥Ä…¥·¥Ñ·¥á: {user_balance} P·¥è…™…¥·¥õs\nR·¥á«´·¥ú…™ Ä·¥á·¥Ö: {cost} P·¥è…™…¥·¥õs"
                )
                return
            
            # Place order via SMM API
            order_id = place_smm_order(service['service_id'], user_state["link"], quantity)
            
            if order_id:
                # Deduct balance
                new_balance = update_user_balance(user_id, -cost)
                
                # Save order to database
                create_order(user_id, service['name'], user_state["link"], quantity, cost, order_id)
                
                success_text = f"""
‚úÖ O Ä·¥Ö·¥á Ä P ü·¥Ä·¥Ñ·¥á·¥Ö S·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü ü è! ‚úÖ

‚ú® S·¥á Ä·¥†…™·¥Ñ·¥á: {service['name']}
üî¢ Q·¥ú·¥Ä…¥·¥õ…™·¥õ è: {quantity}
üí∞ C·¥ès·¥õ: {cost} P·¥è…™…¥·¥õs
üÜî O Ä·¥Ö·¥á Ä ID: {order_id}
üè¶ R·¥á·¥ç·¥Ä…™…¥…™…¥…¢ B·¥Ä ü·¥Ä…¥·¥Ñ·¥á: {new_balance} P·¥è…™…¥·¥õs

O Ä·¥Ö·¥á Ä W…™ ü ü B·¥á C·¥è·¥ç·¥ò ü·¥á·¥õ·¥á·¥Ö S ú·¥è Ä·¥õ ü è! ‚è≥
                """
                
                bot.send_photo(
                    user_id,
                    photo="https://via.placeholder.com/400x200/28a745/ffffff?text=Order+Success",
                    caption=success_text,
                    reply_markup=main_menu_keyboard()
                )
                
                # Notify admin
                try:
                    bot.send_message(
                        ADMIN_ID,
                        f"üõí N·¥á·¥° O Ä·¥Ö·¥á Ä!\n\nUs·¥á Ä: {user_id}\nS·¥á Ä·¥†…™·¥Ñ·¥á: {service['name']}\nQ·¥ú·¥Ä…¥·¥õ…™·¥õ è: {quantity}\nO Ä·¥Ö·¥á Ä ID: {order_id}"
                    )
                except:
                    pass
            else:
                bot.send_message(user_id, "‚ùå F·¥Ä…™ ü·¥á·¥Ö T·¥è P ü·¥Ä·¥Ñ·¥á O Ä·¥Ö·¥á Ä! P ü·¥á·¥Äs·¥á T Ä è A…¢·¥Ä…™…¥ L·¥Ä·¥õ·¥á Ä.")
        
        except ValueError:
            bot.send_message(user_id, "‚ùå I…¥·¥†·¥Ä ü…™·¥Ö Q·¥ú·¥Ä…¥·¥õ…™·¥õ è! P ü·¥á·¥Äs·¥á E…¥·¥õ·¥á Ä A N·¥ú·¥ç ô·¥á Ä.")

def place_smm_order(service_id, link, quantity):
    try:
        # Simulate API call - replace with actual SMM panel API
        import random
        order_id = f"ORD{random.randint(100000, 999999)}"
        return order_id
        
        # Actual API implementation would look like:
        # url = f"https://your-smm-panel.com/api/v2?key={SMM_API_KEY}&action=add&service={service_id}&link={link}&quantity={quantity}"
        # response = requests.get(url)
        # data = response.json()
        # return data.get('order')
    except:
        return None

# Admin commands
@bot.message_handler(commands=['adminox'])
def admin_login(message):
    if message.chat.id != ADMIN_ID:
        bot.send_message(message.chat.id, "‚ùå A·¥Ñ·¥Ñ·¥áss D·¥á…¥…™·¥á·¥Ö!")
        return
    
    bot.send_message(
        message.chat.id,
        "üîê A·¥Ö·¥ç…™…¥ L·¥è…¢…™…¥\n\nP ü·¥á·¥Äs·¥á E…¥·¥õ·¥á Ä T ú·¥á A·¥Ö·¥ç…™…¥ P·¥Äss·¥°·¥è Ä·¥Ö:"
    )
    bot.register_next_step_handler(message, process_admin_password)

def process_admin_password(message):
    if message.text == ADMIN_PASSWORD:
        admin_text = """
üëë A·¥Ö·¥ç…™…¥ P·¥Ä…¥·¥á ü üëë

W·¥á ü·¥Ñ·¥è·¥ç·¥á B·¥Ä·¥Ñ·¥ã, A·¥Ö·¥ç…™…¥! üéâ

C ú·¥è·¥ès·¥á A…¥ O·¥ò·¥õ…™·¥è…¥ F Ä·¥è·¥ç T ú·¥á M·¥á…¥·¥ú B·¥á ü·¥è·¥°:
        """
        
        bot.send_photo(
            message.chat.id,
            photo="https://via.placeholder.com/400x200/dc3545/ffffff?text=Admin+Panel",
            caption=admin_text,
            reply_markup=admin_keyboard()
        )
    else:
        bot.send_message(message.chat.id, "‚ùå I…¥·¥Ñ·¥è Ä Ä·¥á·¥Ñ·¥õ P·¥Äss·¥°·¥è Ä·¥Ö!")

# My Account command
@bot.message_handler(commands=['account'])
def my_account(message):
    user_id = message.chat.id
    user = users_collection.find_one({"user_id": user_id})
    
    if not user:
        user = {
            "user_id": user_id,
            "balance": 0,
            "total_orders": 0,
            "total_deposits": 0
        }
        users_collection.insert_one(user)
    
    account_text = f"""
üë§ M è A·¥Ñ·¥Ñ·¥è·¥ú…¥·¥õ üë§

üè¶ A·¥†·¥Ä…™ ü·¥Ä ô ü·¥á B·¥Ä ü·¥Ä…¥·¥Ñ·¥á: {user.get('balance', 0)} P·¥è…™…¥·¥õs
üõí T·¥è·¥õ·¥Ä ü O Ä·¥Ö·¥á Äs: {user.get('total_orders', 0)} P·¥è…™…¥·¥õs
üí∞ T·¥è·¥õ·¥Ä ü D·¥á·¥ò·¥ès…™·¥õs: {user.get('total_deposits', 0)} P·¥è…™…¥·¥õs
üìÖ M·¥á·¥ç ô·¥á Ä S…™…¥·¥Ñ·¥á: {user.get('joined_date', datetime.now()).strftime('%Y-%m-%d')}

Us·¥á Ä ID: {user_id}
    """
    
    bot.send_photo(
        user_id,
        photo="https://via.placeholder.com/400x200/17a2b8/ffffff?text=My+Account",
        caption=account_text,
        reply_markup=main_menu_keyboard()
    )

# Statistics command
@bot.message_handler(commands=['stats'])
def bot_stats(message):
    total_users = users_collection.count_documents({})
    total_orders = orders_collection.count_documents({})
    
    # Calculate total points in orders
    pipeline = [{"$group": {"_id": None, "total_points": {"$sum": "$cost"}}}]
    result = list(orders_collection.aggregate(pipeline))
    total_points = result[0]['total_points'] if result else 0
    
    stats_text = f"""
üìä B·¥è·¥õ S·¥õ·¥Ä·¥õ…™s·¥õ…™·¥Ñs üìä

üë• T·¥è·¥õ·¥Ä ü Us·¥á Äs: {total_users}
üõí T·¥è·¥õ·¥Ä ü O Ä·¥Ö·¥á Äs: {total_orders}
üí∞ T·¥è·¥õ·¥Ä ü P·¥è…™…¥·¥õs S·¥ò·¥á…¥·¥õ: {total_points}

üöÄ B·¥è·¥õ Is R·¥ú…¥…¥…™…¥…¢ S·¥ç·¥è·¥è·¥õ ú ü è!
    """
    
    bot.send_photo(
        message.chat.id,
        photo="https://via.placeholder.com/400x200/6f42c1/ffffff?text=Bot+Statistics",
        caption=stats_text
    )

# Support command
@bot.message_handler(commands=['support'])
def support(message):
    support_text = """
üìû S·¥ú·¥ò·¥ò·¥è Ä·¥õ & H·¥á ü·¥ò üìû

I“ì Y·¥è·¥ú H·¥Ä·¥†·¥á A…¥ è Iss·¥ú·¥ás O Ä Q·¥ú·¥ás·¥õ…™·¥è…¥s, C·¥è…¥·¥õ·¥Ä·¥Ñ·¥õ O·¥ú Ä S·¥ú·¥ò·¥ò·¥è Ä·¥õ T·¥á·¥Ä·¥ç:

üë§ C·¥ús·¥õ·¥è·¥ç·¥á Ä S·¥ú·¥ò·¥ò·¥è Ä·¥õ: @Username
üìß E·¥ç·¥Ä…™ ü: support@example.com
üåê W·¥á ôs…™·¥õ·¥á: example.com

W·¥á' Ä·¥á H·¥á Ä·¥á T·¥è H·¥á ü·¥ò Y·¥è·¥ú 24/7! ‚è∞
    """
    
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("üë§ C·¥è…¥·¥õ·¥Ä·¥Ñ·¥õ S·¥ú·¥ò·¥ò·¥è Ä·¥õ", url="https://t.me/username"))
    
    bot.send_photo(
        message.chat.id,
        photo="https://via.placeholder.com/400x200/ffc107/ffffff?text=Support",
        caption=support_text,
        reply_markup=markup
    )

# Handle text messages
@bot.message_handler(func=lambda message: True)
def handle_text(message):
    text = message.text.lower()
    
    if text in ['menu', 'start', 'home']:
        send_welcome(message)
    elif text in ['balance', 'account']:
        my_account(message)
    elif text in ['stats', 'statistics']:
        bot_stats(message)
    elif text in ['support', 'help']:
        support(message)
    else:
        bot.send_message(
            message.chat.id,
            "‚ùì I D·¥è…¥'·¥õ U…¥·¥Ö·¥á Äs·¥õ·¥Ä…¥·¥Ö T ú·¥Ä·¥õ C·¥è·¥ç·¥ç·¥Ä…¥·¥Ö.\n\nUs·¥á /start T·¥è S·¥á·¥á T ú·¥á M·¥Ä…™…¥ M·¥á…¥·¥ú."
        )

# Start the bot
if __name__ == "__main__":
    print("ü§ñ B·¥è·¥õ Is R·¥ú…¥…¥…™…¥…¢...")
    try:
        bot.polling(none_stop=True)
    except Exception as e:
        print(f"‚ùå E Ä Ä·¥è Ä: {e}")
        time.sleep(15)
